generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AgentStatus {
  ACTIVE
  PAUSED
  STOPPED
}

enum OrderStatus {
  PENDING
  EXECUTED
  REJECTED
}

enum VenueType {
  SPOT
  PERP
  PREDICTION
}

enum OrderSide {
  BUY
  SELL
}

enum OrderRejectionReason {
  INSUFFICIENT_FUNDS
  INVALID_PAYMENT
  FACILITATOR_UNAVAILABLE
  RISK_LIMIT
  INVALID_REQUEST
}

enum SettlementStatus {
  SETTLED
  FAILED
}

enum EventStatus {
  INFO
  SUCCESS
  ERROR
}

enum EventName {
  AGENT_CREATED
  X402_CHALLENGE_ISSUED
  X402_PAYMENT_SETTLED
  TRADE_EXECUTED
  TRADE_REJECTED
  RISK_LIMIT_HIT
}

model Agent {
  agentId       String       @id
  ownerAddress  String
  status        AgentStatus  @default(ACTIVE)
  createdAt     DateTime     @default(now())
  orders        Order[]
  settlements   Settlement[]
  events        Event[]
}

model Order {
  orderId              String               @id
  agentId              String
  status               OrderStatus
  venueType            VenueType
  marketId             String
  side                 OrderSide
  size                 String
  limitPrice           String?
  rejectionReason      OrderRejectionReason?
  paymentSettlementId  String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  agent                Agent                @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  settlement           Settlement?          @relation(fields: [paymentSettlementId], references: [settlementId], onDelete: SetNull)

  @@index([agentId])
  @@index([createdAt])
}

model Settlement {
  settlementId   String            @id
  agentId        String
  status         SettlementStatus
  txHash         String?
  providerRef    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  agent          Agent             @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  orders         Order[]

  @@index([agentId])
  @@index([createdAt])
}

model Event {
  eventId      String      @id
  eventName    EventName
  agentId      String
  timestamp    DateTime
  status       EventStatus
  metadata     Json
  createdAt    DateTime    @default(now())

  agent        Agent       @relation(fields: [agentId], references: [agentId], onDelete: Cascade)

  @@index([agentId, timestamp])
}

model IdempotencyKey {
  key          String    @id
  route        String
  requestHash  String
  responseJson Json
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([route])
}
