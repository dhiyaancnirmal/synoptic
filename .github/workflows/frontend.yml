name: Frontend

on:
  push:
    paths:
      - "apps/dashboard/**"
      - "apps/agent-server/**"
      - "packages/types/**"
      - ".github/workflows/frontend.yml"
  pull_request:
    paths:
      - "apps/dashboard/**"
      - "apps/agent-server/**"
      - "packages/types/**"
      - ".github/workflows/frontend.yml"

jobs:
  dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - name: Verify Node Version Pin
        run: |
          ACTUAL="$(node -v)"
          if [ "$ACTUAL" != "v22.22.0" ]; then
            echo "Expected Node v22.22.0, got $ACTUAL"
            exit 1
          fi

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Prepare Agent Browser Runtime
        run: pnpm --filter @synoptic/dashboard exec agent-browser install || true

      - name: Lint
        run: pnpm --filter @synoptic/dashboard lint

      - name: Legacy Endpoint Guard
        run: pnpm --filter @synoptic/dashboard test:legacy-routes

      - name: Typecheck
        run: pnpm --filter @synoptic/dashboard typecheck

      - name: Unit Tests
        run: pnpm --filter @synoptic/dashboard test

      - name: Integration E2E (backend + frontend)
        run: |
          set -euo pipefail
          FRONTEND_PORT=3100
          BACKEND_PORT=3101
          BASE_URL="http://127.0.0.1:${FRONTEND_PORT}"
          API_URL="http://127.0.0.1:${BACKEND_PORT}"

          PORT="${BACKEND_PORT}" pnpm --filter @synoptic/agent-server dev &
          BACKEND_PID=$!

          PORT="${FRONTEND_PORT}" \
          NEXT_PUBLIC_AGENT_SERVER_URL="${API_URL}" \
          NEXT_PUBLIC_DASH_AGENT_ID="dev-agent" \
          NEXT_PUBLIC_DASH_OWNER_ADDRESS="0xdev" \
          NEXT_PUBLIC_API_MODE="canonical" \
          NEXT_PUBLIC_ALLOW_COMPAT_MODE="false" \
          pnpm --filter @synoptic/dashboard dev &
          FRONTEND_PID=$!

          cleanup() {
            kill "${BACKEND_PID}" "${FRONTEND_PID}" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for _ in $(seq 1 80); do
            [ "$(curl -s -o /dev/null -w '%{http_code}' "${API_URL}/health" || true)" = "200" ] && break
            sleep 0.5
          done

          for _ in $(seq 1 120); do
            code="$(curl -s -o /dev/null -w '%{http_code}' "${BASE_URL}/" || true)"
            [ "${code}" = "200" ] && break
            sleep 0.5
          done

          [ "$(curl -s -o /dev/null -w '%{http_code}' "${API_URL}/health")" = "200" ]
          [ "$(curl -s -o /dev/null -w '%{http_code}' "${BASE_URL}/")" = "200" ]

          EXPECT_RUNNING_SERVERS=1 \
          FRONTEND_PORT="${FRONTEND_PORT}" \
          BACKEND_PORT="${BACKEND_PORT}" \
          BASE_URL="${BASE_URL}" \
          API_URL="${API_URL}" \
          pnpm --filter @synoptic/dashboard test:e2e

      - name: Build
        run: pnpm --filter @synoptic/dashboard build
